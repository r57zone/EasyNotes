<!DOCTYPE html>
<html data-theme="default">
<!-- <html data-theme="default" manifest="app.manifest"> iOS < 13 -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>EasyNotes</title>
<meta name="color-scheme" content="dark">
<meta name="author" content="r57zone">
<meta name="apple-mobile-web-app-title" content="EasyNotes">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<!--<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />-->
<link rel="apple-touch-icon" href="icons/icon-76.png">
<link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72.png">
<link rel="apple-touch-icon" sizes="76x76" href="icons/icon-76.png">
<link rel="apple-touch-icon" sizes="114x114" href="icons/icon-114.png">
<link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120.png">
<link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144.png">
<link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
<!--<link rel="apple-touch-startup-image" href="images/launch.png">-->
<link rel="stylesheet" href="style.css">
<script src="langs.js"></script>
<script type="text/javascript">
	const PlatformAndroid = 0;
	const PlatformIOS = 1;
	const PlatformWindows = 2;
	let DevicePlatform = -1;
	let PlatformNames = ['Android', 'iOS', 'Windows'];
	let UseManualAddress = true; // Ручной ввод адреса
	let IsPWA = false; // Ручной ввод адреса
	let IsWindowsClient = false;
	
	let FirstRun = false;
	let DeviceID;
	let TabletMode = false;

	let NotesAr = [];
	let ActionsAr = [];
	
	let CurNoteID = -1; // По умолчанию новая заметка
	let LatestNote;
	let CurNoteDateTime;
	
	let SyncWait = false;

	let UpdateDateTime = true;
	
	let HideFirstNotifyError = true; // На замену navigator.onLine (постоянно стала возвращать true на Android), для iOS ставим true
	
	// Настройки для Android
	let ServerAddress; // Для вывода в настройках
	let ServerPort; // Храним для автопоиска
	let SyncAddress; // Полный адрес для синхронизации
	let AutoSearchIP = false;
	
	let SearchShown = false;
	let Categories = [];
	let CategoriesShownList = false;
	let CategoriesNoteShown = false;
	let LastSearchValue = '';
	
	let DarkThemeStartHour = 18;
	let DarkThemeEndHour = 8;
	
	// Кеширование платформы
	if (localStorage.getItem('DevicePlatform') == null) {
		// Автоопределение платформы
		if (/Android/i.test(window.navigator.userAgent))
			DevicePlatform = PlatformAndroid;
		else if (/iPhone|iPod|iPad/i.test(window.navigator.userAgent))
			DevicePlatform = PlatformIOS;
		else if (/Edg/.test(navigator.userAgent))
			DevicePlatform = PlatformWindows;
		localStorage.setItem('DevicePlatform', DevicePlatform);
	} else
		DevicePlatform = localStorage.getItem('DevicePlatform');
		
	// Дополнительные стили
	function AddCSSFile(cssFile) {
		let cssFiles = [location.pathname.split('/').pop().replace(/\.\w+$/, '.css'), cssFile];
		cssFiles.forEach(function(file) {
			let link = document.createElement('link');
			link.href = file;
			link.type = 'text/css';
			link.rel = 'stylesheet';
			link.media = 'screen,print';
			document.head.appendChild(link);
		});
	}
	if (DevicePlatform == PlatformIOS)
		AddCSSFile('ios.css');
	else // Android / Windows / Web
		AddCSSFile('any.css');
	if (IsWindowsClient && DevicePlatform == PlatformWindows)
		AddCSSFile('windows.css');
		
	//console.log(PlatformNames[DevicePlatform]);
	
	function GetUTCTimeStamp() // Со смещением UTC зоны
	{
		let CurDate = new Date;
		return Math.floor(Date.UTC(CurDate.getFullYear(), CurDate.getMonth(), CurDate.getDate(), CurDate.getHours(), CurDate.getMinutes(), CurDate.getSeconds(), CurDate.getMilliseconds()) / 1000);
	}

	function GetTimeStamp() // UTC +0 (без смещения)
	{
		return Math.floor(new Date() / 1000);
	}
	
	function StrToCharCodes(Str){
		let NewStr = '';
		let CharCode = 0;
		for (let i = 0; i < Str.length; i++)
			NewStr += 'x' + Str.charCodeAt(i);
			
		return NewStr;
	}
	
	function CharCodesToStr(Str){
		let NewStr = '';
		if (Str.length = 0) return '';
		if (Str[0] != 'x') return '';
		Str = Str.substring(1, Str.length);
		Str += 'x';
		while (Str.indexOf('x') > 0) {
			NewStr += String.fromCharCode(parseInt(Str.substring(0, Str.indexOf('x')), 0));
			Str = Str.substring(Str.indexOf('x') + 1, Str.length);
		}	
		return NewStr;
	}
	
	function FullReset()
	{
		if (!confirm(IDS_CONFIRM_FULL_RESET)) return;
		localStorage.clear();
		document.location.reload();
	}
	
	function NoteDateAgo(TimeStampSec) // Дней прошло
	{
		try {
			let date = new Date();
			date.setTime(TimeStampSec * 1000 + date.getTimezoneOffset() * 60000 ); // После присвоения времени добавляется смещение UTC, поэтому вычитаем его.

			let CurDate = new Date(); // Текущее время для сравнения
			let mTime = '' + date.getHours();
			if (date.getMinutes() < 10) {mTime += ':0' + date.getMinutes();} else {mTime += ':' + date.getMinutes();}
			
			// Даты без времени для точного определения пройденных дней
			let DCurDate = new Date(CurDate.getFullYear(), CurDate.getMonth(), CurDate.getDate(), 0, 0, 0, 0);
			let DDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
			
			let DaysAgo = Math.floor((DCurDate - DDate) / (1000 * 60 * 60 * 24));
			
			if (DaysAgo == 0) MyDate = IDS_TODAY;
			if (DaysAgo == 1) MyDate = IDS_YESTERDAY;
			if (DaysAgo > 1) MyDate = DaysAgo + ' ' + IDS_DAYSAGO;

			return MyDate;
		} catch (e) {
			return '-';
		}
	}
	
	function NoteDate(TimeStampSec) // Дата в заметке
	{
		try {
			let date = new Date();
			date.setTime(TimeStampSec * 1000 + date.getTimezoneOffset() * 60000 ); // После присвоения времени добавляется смещение UTC, поэтому вычитаем его.

			let CurDate = new Date(); // Текущее время для сравнения
			let mTime = '' + date.getHours();
			if (date.getMinutes() < 10) {mTime += ':0' + date.getMinutes();} else {mTime += ':' + date.getMinutes();}
			
			let MyDate = date.getDate() + ' ' + IDS_MONTHS[date.getMonth()]; //День, месяц
			if (CurDate.getFullYear() != date.getFullYear()) MyDate += ' ' + date.getFullYear() + ','; //Год
			MyDate += ' ' + mTime;
			
			return MyDate;
		} catch (e) {
			return '-';
		}
	}
	
	function ListDate(TimeStampSec) // Дата в списке
	{
		try {
			let date = new Date();
			date.setTime(TimeStampSec * 1000 + date.getTimezoneOffset() * 60000 ); // После присвоения времени добавляется смещение UTC, поэтому вычитаем его.

			let CurDate = new Date(); // Текущее время для сравнения
			let mTime = '' + date.getHours();
			if (date.getMinutes() < 10) {mTime += ':0' + date.getMinutes();} else {mTime += ':' + date.getMinutes();}
			
			let MyDate = date.getDate() + ' ' + IDS_MONTHS[date.getMonth()];
			if (CurDate.getFullYear() != date.getFullYear()) MyDate += ' ' + date.getFullYear();
			
			// Даты без времени для точного определения пройденных дней
			let DCurDate = new Date(CurDate.getFullYear(), CurDate.getMonth(), CurDate.getDate(), 0, 0, 0, 0);
			let DDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
			
			let DaysAgo = Math.floor((DCurDate - DDate) / (1000 * 60 * 60 * 24));
			
			let GetCurDay = CurDate.getDay(); 
			if (GetCurDay == 0) GetCurDay = 7;
			
			if (DaysAgo < GetCurDay) MyDate = IDS_DAYOFWEEK[date.getDay() - 1];

			if (DaysAgo == 0) MyDate = mTime;
			if (DaysAgo == 1) MyDate = IDS_YESTERDAY;

			return MyDate;
		} catch (e) {
			return '-';
		}
	}
	
	function ExtractTitle(Str){
		if (Str.indexOf('\n') > 0)
			Str = Str.substring(0, Str.indexOf('\n'));
		if (Str.endsWith(':'))
			Str = Str.slice(0, -1);
		if (Str.length > 50)
			Str = Str.substring(0, 50) + '...';
		return Str;
	}
	
	function ChangeDateTimeStatus()
	{
		if (CurNoteID == '-1')
			return;
		if (UpdateDateTime == false)
		{
			UpdateDateTime = true;
			Notification(IDS_DATE_UPDATE);
			
		} else {
			UpdateDateTime = false;
			Notification(IDS_DATE_NOT_UPDATE);
		}
	}
	
	function ShowNotes(SearchValue) // trim(), toLowerCase()
	{
		if (TabletMode == false)
			document.getElementById('editor').style.display = 'none';
		document.getElementById('list').style.display = 'block';
		
		let NotesStr = '';
		let NotesCount = 0;
		
		LastSearchValue = SearchValue; // Сохраняем на случай удаления заметки, при поиске
		
		// Вывод
		NotesAr.forEach(function(Note) {
			NoteText = CharCodesToStr(Note.Note);
			if (SearchValue == '' || NoteText.toLowerCase().indexOf(SearchValue.toLowerCase()) >= 0) {
				NotesCount += 1;
				NotesStr += '<div onclick="GetNote(' + Note.ID  + ')" id="note">' + 
							'<div id="title">' + ExtractTitle(NoteText) + '</div>' +
							'<div id="date">' + ListDate(Note.DateTime) + '</div>' +
							'</div>';
				}
		});
		
		document.getElementById('NotesCount').innerHTML = IDS_NOTES + ' (' + NotesCount + ')';
		document.getElementById('items').innerHTML = NotesStr; // Заменяем, чтобы не мерцала пустота
		NotesStr = '';
	}
	
	function BackNote() {
		if (TabletMode == false)
			document.getElementById('editor').style.display = 'none';
		document.getElementById('list').style.display = 'block';
		
		if (CategoriesShownList || SearchShown) // Оставляем заметки, если выбрана категория или поиск
			return;
		else
			ShowNotes('');
	}
	
	function ShowHideCategoriesList() {
		if (SearchShown) SearchShowHide();
	
		if (CategoriesShownList) {
			CategoriesShownList = false;
			ShowNotes('');
			return;
		}
		
		if (TabletMode == false)
			document.getElementById('editor').style.display = 'none';
		document.getElementById('list').style.display = 'block';

		let CatsStr = '';
		
		for (let Category of Categories) {
			CatsStr += '<div onclick="ShowNotes(\'' + Category + '\')" id="note">' + 
						'<div id="title">' + ExtractTitle(Category) + '</div>' +
						'<div id="date"></div>' +
						'</div>';
		}
		document.getElementById('NotesCount').innerHTML = IDS_CATEGORIES + ' (' + Categories.length + ')';
		document.getElementById('items').innerHTML = CatsStr; // Заменяем, чтобы не мерцала пустота
		CatsStr = '';
		CategoriesShownList = true;	
	}
	
	function NewNote(MemoFocus)
	{
		HideNoteCategories();
		CurNoteID = '-1';
		if (TabletMode == false)
			document.getElementById('list').style.display = 'none';
		document.getElementById('settings').style.display = 'none';
		document.getElementById('editor').style.display = 'block';
		
		document.getElementById('memo').value = '';
		if (DevicePlatform != PlatformIOS && MemoFocus) // На iOS баг с увеличением textarea, при клике
			document.getElementById('memo').select();
		document.getElementById('NoteTitle').innerHTML = IDS_NEW_NOTE;
		
		document.getElementById('DaysAgo').innerHTML = NoteDateAgo(GetUTCTimeStamp());
		document.getElementById('DateNote').innerHTML = NoteDate(GetUTCTimeStamp());
	}
	
	function ShowSettings()
	{
		if (TabletMode == false)
			document.getElementById('list').style.display = 'none';
		document.getElementById('editor').style.display = 'none';
		document.getElementById('settings').style.display = 'block';
		document.getElementById('localstoragesize').innerHTML = IDS_LOCAL_STORAGE.replace('%s', Math.trunc((new Blob(Object.values(localStorage)).size / 1024)));
	}
	
	function BackSettings() {
		document.getElementById('settings').style.display = 'none';
		if (TabletMode == false)
			document.getElementById('list').style.display = 'block';
		else
			document.getElementById('editor').style.display = 'block';
	}
	
	function BackTheme(){
		document.documentElement.setAttribute('data-theme', 'default');
		document.getElementsByTagName('meta')['color-scheme']?.setAttribute('content', 'light');
	}
	
	function DarkTheme(){
		document.documentElement.setAttribute('data-theme', 'dark');
		document.getElementsByTagName('meta')['color-scheme']?.setAttribute('content', 'dark');
	}
	
	function IsDomain(Str){
		Str = Str.toLowerCase();
		if (Str.indexOf('http://') == 0 || Str.indexOf('https://') == 0)
			return true;
		else
			return false;
	}
	
	function SettingsDone()
	{
		// Настройки с изменяемым адресом
		if (UseManualAddress) {
			// Port
			ServerPort = document.getElementById('ServerPort').value;
			localStorage.setItem('ServerPort', ServerPort); // Храним для автопоиска
		
			// IP / Address
			ServerAddress = document.getElementById('ServerAddress').value;
			localStorage.setItem('ServerAddress', ServerAddress);
			
			if (IsDomain(ServerAddress))
				SyncAddress = ServerAddress;
			else
				SyncAddress = 'http://' + ServerAddress;
			
			if (ServerPort != '80')
				SyncAddress += ':' + ServerPort;
			
			// Auto search IP
			AutoSearchIP = document.getElementById('AutoSearchIPCB').checked; // Глобальная переменная
			localStorage.setItem('AutoSearchIP', AutoSearchIP);
		} else
			SyncAddress = ''; // Для статичной синхронизации адрес относительный - /api/...
		
		// Сохраняем адрес полной синхронизации
		localStorage.setItem('SyncAddress', SyncAddress);
		
		// Auto sync
		let AutoSyncCB = document.getElementById('AutoSyncCB').checked;
		localStorage.setItem('AutoSync', AutoSyncCB);
		
		// Dark Theme
		DarkThemeStartHour = parseInt(document.getElementById('DarkThemeStartHour').value);
		DarkThemeEndHour = parseInt(document.getElementById('DarkThemeEndHour').value);
		localStorage.setItem('DarkThemeStartHour', DarkThemeStartHour);
		localStorage.setItem('DarkThemeEndHour', DarkThemeEndHour);
		
		let DarkThemeCB = document.getElementById('DarkThemeCB').checked;
	
		// Theme time	
		let ThemeTimeCB = document.getElementById('ThemeTimeCB').checked;
		if (ThemeTimeCB) {
			DarkThemeCB = false;
			document.getElementById('DarkThemeCB').checked = false;
			let date = new Date();
			if (date.getHours() < DarkThemeEndHour || date.getHours() >= DarkThemeStartHour)
				DarkThemeCB = true;
		}
		
		// Dark Theme
		if (DarkThemeCB)
			DarkTheme();
		else
			BackTheme();
		
		// Save dark theme status
		localStorage.setItem('DarkTheme', DarkThemeCB);
		
		// Theme time status
		localStorage.setItem('ThemeTime', ThemeTimeCB);
		
		localStorage.setItem('Categories', document.getElementById('CategorySettingsInput').value);
		Categories = document.getElementById('CategorySettingsInput').value.split('\n');
		//console.log(Categories);
		
		BackSettings();
	}
	
	function GetNote(NoteID)
	{	
		HideNoteCategories();
		if (NoteID == -1)
		{
			NewNote(false)
			return;
		}
		UpdateDateTime = true;
		
		const CurNote = NotesAr.find(function(Note) {
			return Note.ID === NoteID;
		});
		
		if (CurNote) {
			document.getElementById('memo').value = CharCodesToStr(CurNote.Note);
			LatestNote = document.getElementById('memo').value;
			document.getElementById('NoteTitle').innerHTML = ExtractTitle(CharCodesToStr(CurNote.Note));
			document.getElementById('DaysAgo').innerHTML = NoteDateAgo(CurNote.DateTime);
			document.getElementById('DateNote').innerHTML = NoteDate(CurNote.DateTime); 
			CurNoteID = CurNote.ID;
			CurNoteDateTime = CurNote.DateTime;
			if (TabletMode == false)
				document.getElementById('list').style.display = 'none';
			document.getElementById('settings').style.display = 'none';
			document.getElementById('editor').style.display = 'block';
		}
		//console.log('GetNote ' + NoteID);
	}
	
	function NoteDone()
	{
		if (SearchShown) SearchShowHide();
		HideNoteCategories();
		let CurTimeStamp = GetTimeStamp();
		let UTCTimeStamp = GetUTCTimeStamp();
		let MemoText = document.getElementById('memo').value;
		let LatestCurNoteID = CurNoteID; // Для мновенного переключения на новую заметку, без ожидания выполнения SQL
		let NotesChanded = false;
		
		// Новая заметка
		if (CurNoteID == '-1') {
			// Не создаем заметку без текста
			if (MemoText.trim() != '') {
				NotesAr.push({
					ID: CurTimeStamp,
					DateTime: UTCTimeStamp,
					Note: StrToCharCodes(MemoText)
				});
				
				ActionsAr.push({
					Name: 'insert',
					ID: CurTimeStamp,
					DateTime: UTCTimeStamp,
					Note: StrToCharCodes(MemoText)
				});
				NotesChanded = true;
			}
			//console.log('Inserted done');
		} else if (LatestNote.trim() != MemoText.trim()) { // Добавлять только при наличии изменений
			
			const CurNote = NotesAr.find(function(Note) {
				return Note.ID === LatestCurNoteID;
			});

			if (UpdateDateTime) { // Обновление времени
				CurNote.DateTime = UTCTimeStamp;
				CurNote.Note = StrToCharCodes(MemoText);
				
				ActionsAr.push({
					Name: 'update',
					ID: LatestCurNoteID,
					DateTime: UTCTimeStamp,
					Note: StrToCharCodes(MemoText)
				});

			} else { // Сохранение старого времени
				CurNote.Note = StrToCharCodes(MemoText);
				
				ActionsAr.push({
					Name: 'update',
					ID: LatestCurNoteID,
					DateTime: CurNoteDateTime,
					Note: StrToCharCodes(MemoText)
				});
				
			}
			
			NotesChanded = true;
			//console.log('Updated done');
		}
		
		
		if (NotesChanded) { // Если заметка добавлена / обновлена
			// Сортировка по времени
			NotesAr.sort(function(a, b) { return b.DateTime - a.DateTime; }); 
			
			localStorage.setItem('Notes', JSON.stringify(NotesAr));
			localStorage.setItem('Actions', JSON.stringify(ActionsAr));
		}
		
		if (TabletMode) // Новая заметка открывается только в режиме планшета
			NewNote(true);
		ShowNotes('');
	}
	
	function RemNote()
	{	
		HideNoteCategories();
		if (CurNoteID == '-1') {ShowNotes(''); return;}
		
		let IndexToRemove = NotesAr.findIndex(Note => Note.ID === CurNoteID);
		if (IndexToRemove !== -1)
			NotesAr.splice(IndexToRemove, 1);
		
		ActionsAr.push({
			Name: 'delete',
			ID: CurNoteID,
			DateTime: 0,
			Note: ''
		});
		
		localStorage.setItem('Notes', JSON.stringify(NotesAr));
		localStorage.setItem('Actions', JSON.stringify(ActionsAr));
		
		if (CategoriesShownList || SearchShown) // Оставлять выбранную категорию или поиск
			ShowNotes(LastSearchValue);
		else
			ShowNotes('');
		
		if (TabletMode) // Новая заметка открывается только в режиме планшета
			NewNote(false);
		//console.log('Deleted ' + CurNoteID);
	}
	
	function Notification(Str){
		if (HideFirstNotifyError) // На замену navigator.onLine (постоянно стала возвращать true на Android)
		{
			HideFirstNotifyError = false;
			if (Str == IDS_CONNECTION_FAILED)
				return;
		}
		document.getElementById('sync-progress').style.display = 'none';
		let notifyBlock = document.getElementById('notification');
		notifyBlock.innerHTML = Str;
		notifyBlock.className = 'show';

		setTimeout(function(){
			notifyBlock.className = notifyBlock.className.replace('show', ''); 
		}, 3000);
	}
	
	function AddNoteCategory(Category) {
		CategoriesNoteShown = false;
		document.getElementById('note-categories').style.display = 'none';
		let Memo = document.getElementById('memo');
		let MemoValue = Memo.value.trim();
		if (MemoValue.indexOf(Category) == -1) {
			let LastLine = MemoValue.split('\n').pop();
			if (LastLine && LastLine.charAt(0) === '#') {
				Memo.value += Category + '\n';
			} else {
				if (MemoValue !== '') Memo.value += '\n\n';
				Memo.value += Category + '\n';
			}
		}
	}
		
	function ShowHideNoteCategories() {
		if (CategoriesNoteShown) {
			document.getElementById('note-categories').style.display = 'none';
			CategoriesNoteShown = false;
			SearchShown = false;
		} else {
			document.getElementById('note-categories').style.display = 'block';
			document.getElementById('note-categories').scrollTop = 0
			let CatsStr = '';

			for (let Category of Categories)
				CatsStr += '<div onclick="AddNoteCategory(\'' + Category + '\')" id="item">' + Category + '</div>';
			document.getElementById('note-categories').innerHTML = CatsStr;
			CategoriesNoteShown = true;
		}
	}
	
	function HideNoteCategories() {
		if (CategoriesNoteShown) {
			CategoriesNoteShown = false;
			document.getElementById('note-categories').style.display = 'none';
		}
	}
		
	function SearchShowHide() {
		if (SearchShown) { // Скрытие
			SearchShown = false;
			CategoriesShownList = false;
			document.getElementById('search-block').style.display = 'none';
			document.getElementById('Search').value = '';
			ShowNotes('');
		} else { // Показ
			SearchShown = true;
			document.getElementById('search-block').style.display = 'block';
		}
	}
	
	let rotationSyncBtnAngle = 0;
	function rotateSyncBtn(btnElement) {
		rotationSyncBtnAngle += 360;
		btnElement.style.transform = 'rotate(' + rotationSyncBtnAngle + 'deg)';
	}
	
	function GetData(URL){
		return new Promise(function(resolve, reject) {
			let request = new XMLHttpRequest();
			
			request.open('GET', URL, true);
			
			request.onload = function() {
				if	(request.status == 200)
					resolve(request.responseText);
				else
					reject();
			}
			
			request.onerror = function() {
				reject();
			};
			
			request.send();
		});
	}
	
	function SendData(URL, Data){
		 return new Promise(function(resolve, reject) {
		 
			let request = new XMLHttpRequest();
			request.open('POST', URL);
			request.setRequestHeader('Content-type', 'text/plain');
			//request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
			
			request.onload = function() {
				if	(request.status == 200)
					resolve(request.response);
				else
					reject();
			}
			
			request.onerror = function() {
				reject();
			};
			
			request.send(Data);
		});
	}
	
	function GetDeviceID(){
		let DeviceOS = 'Unknown'
		if (/Android/i.test(window.navigator.userAgent))
			DeviceOS = 'Android';
		else if (/iPhone|iPod|iPad/i.test(window.navigator.userAgent))
			DeviceOS = 'iOS';
		else if (/Edg/.test(navigator.userAgent))
			DeviceOS = 'Windows';
			
		return DeviceOS + '_' + Math.random().toString(36).substr(2, 9);
	}
	
	function Sync(){
		if (SyncWait) // Ждем выполнения
			return;
		
		if (window.navigator.onLine) {
			SyncWait = true;
		
			if (HideFirstNotifyError == false) // Android, из-за неработающего navigator.onLine
				document.getElementById('sync-progress').style.display = 'block';
			
			function SyncNotes(){
									
				// Первый запуск
				if (FirstRun) {
					//console.log('FirstRun');
					GetData(SyncAddress + '/api/auth?id=' + DeviceID).then(function(responseText) {
						if (responseText == 'auth:ok') {
							//console.log('auth:ok');

							// Получение всех заметок при первом запуске
							let XMLDoc = document.createElement('div');
							
							GetData(SyncAddress + '/api/notes?id=' + DeviceID).then(function(responseNotes) {
								XMLDoc.innerHTML = responseNotes;
								
								let NoteItems = XMLDoc.getElementsByTagName('note');
								for (let i = 0; i < NoteItems.length; i++)
									NotesAr.push({
										ID: parseInt(NoteItems[i].getAttribute('id')),
										DateTime: parseInt(NoteItems[i].getAttribute('datetime')),
										Note: NoteItems[i].innerHTML
									});
									//InsertNote(NoteItems[i].getAttribute('id'), NoteItems[i].innerHTML, NoteItems[i].getAttribute('datetime'));
						
								localStorage.setItem('Notes', JSON.stringify(NotesAr));
						
								delete XMLDoc;
								
								ShowNotes('');
								
								Notification(IDS_SYNC_SUCCESSFUL);
								
								// Сохраняем статус успешного первого запуска
								FirstRun = false;
								localStorage.setItem('FirstRun', FirstRun);
								
								SyncWait = false; // Разрешаем повторную синхронизацию;
								
							}).catch(function() {
								SyncWait = false; // Разрешаем повторную синхронизацию;
								
								Notification(IDS_CONNECTION_FAILED);
							});

						} else {
							SyncWait = false; // Разрешаем повторную синхронизацию;
							
							Notification(IDS_AUTH_REJECT);
						}
							
						//console.log(responseText);
					}).catch(function() {
						SyncWait = false; // Разрешаем повторную синхронизацию;
						
						Notification(IDS_CONNECTION_FAILED);
					});
						
				} else { // Второй и последующие запуски
					// Получение действий
					let XMLDoc = document.createElement('div');
					GetData(SyncAddress + '/api/actions?id=' + DeviceID).then(function(responseNotes) {
						XMLDoc.innerHTML = responseNotes;
						
						// Удаляем действия
						GetData(SyncAddress + '/api/received?id=' + DeviceID).then(function(responseStatus) {
						
							if (responseStatus == 'ok') {
								let ActionsItems = XMLDoc.getElementsByTagName('*');
								for (let i = 0; i < ActionsItems.length; i++) { 

									let ReceivedNoteID = parseInt(ActionsItems[i].getAttribute('id'));
									let ReceivedNoteDateTime = parseInt(ActionsItems[i].getAttribute('datetime'));
									let ReceivedNote = ActionsItems[i].innerHTML;
									
									if (ActionsItems[i].tagName == 'INSERT')
										NotesAr.push({
											ID: ReceivedNoteID,
											DateTime: ReceivedNoteDateTime,
											Note: ReceivedNote
										});
										
									if (ActionsItems[i].tagName == 'UPDATE') {
										const UpdateNote = NotesAr.find(function(Note) {
											return Note.ID === ReceivedNoteID;
										});
										UpdateNote.DateTime = ReceivedNoteDateTime;
										UpdateNote.Note = ReceivedNote;
									}
										
									if (ActionsItems[i].tagName == 'DELETE') {
										let IndexToRemove = NotesAr.findIndex(Note => Note.ID === ReceivedNoteID);
										if (IndexToRemove !== -1)
											NotesAr.splice(IndexToRemove, 1);
									}
								}
								
								// Сортировка по времени
								NotesAr.sort(function(a, b) { return b.DateTime - a.DateTime; }); 
								
								localStorage.setItem('Notes', JSON.stringify(NotesAr));
								
								ShowNotes('');
								if (TabletMode) // Новая заметка открывается только в режиме планшета, нужно для того, чтобы старая заметка не оставалась в интерфейсе, если сервер её удалил
									NewNote(false);
							
								Notification(IDS_SYNC_SUCCESSFUL);
							} else if (responseStatus == 'auth:denied') {
								FirstRun = true;
								//console.log(responseStatus);
							} else
								Notification(IDS_CONNECTION_FAILED);
						
							SyncWait = false; // Разрешаем повторную синхронизацию
						
						}).catch(function() {
							SyncWait = false; // Разрешаем повторную синхронизацию;
							
							Notification(IDS_CONNECTION_FAILED);
						});
				
						delete XMLDoc;
						
					}).catch(function() {
						SyncWait = false; // Разрешаем повторную синхронизацию;
						
						Notification(IDS_CONNECTION_FAILED);
					});
					
				}
			}	
				
			// Генерация XML действий пользователя и отправка на "сервер"
			if (FirstRun == false) // При первом запуске отправлять нечего
				GetData(SyncAddress + '/api/auth?id=' + DeviceID).then(function(responseText) { // Проверка авторизации
					if (responseText == 'auth:ok') {

						let XMLAPI = '<actions>\n';

						ActionsAr.forEach(function(Action) {
							if (Action.Name == 'insert')
								XMLAPI += '\t<insert id="' + Action.ID + '" datetime="' + Action.DateTime + '">' + Action.Note + '</insert>\n';
							if (Action.Name == 'update')
								XMLAPI += '\t<update id="' + Action.ID + '" datetime="' + Action.DateTime + '">' + Action.Note + '</update>\n';
							if (Action.Name == 'delete')
								XMLAPI += '\t<delete id="' + Action.ID + '"></delete>\n';
						});
						
						XMLAPI += '</actions>';
						
						//alert(XMLAPI);

						// Отправка XML на "сервер"
						SendData(SyncAddress + '/api/syncnotes?id=' + DeviceID, XMLAPI).then(function(responseStatus) {

							if (responseStatus == 'ok') {
								ActionsAr = [];
								localStorage.setItem('Actions', '');
								
								SyncNotes();
							} else {
								SyncWait = false; // Разрешаем повторную синхронизацию;
								
								Notification(IDS_CONNECTION_FAILED);
							}
						}).catch(function() {
							SyncWait = false; // Разрешаем повторную синхронизацию;
						
							Notification(IDS_CONNECTION_FAILED);
						});
								
						// Завершение генерации и отправки XML API.
					} else {
						SyncWait = false; // Разрешаем повторную синхронизацию;
							
						Notification(IDS_AUTH_REJECT);
					}
				}).catch(function() {
					SyncWait = false; // Разрешаем повторную синхронизацию;
							
					Notification(IDS_CONNECTION_FAILED);
				});
			
			
			if (FirstRun)
				SyncNotes();
		
		} else {
			Notification(IDS_SYNC_NEED_CONNECT);
		}
	}
	
	function SyncWithFoundAddress(){
		// Проверка доступности IP адреса
		let FoundIPAddress = false;
		function CheckIPStatus(IP){
			if (FoundIPAddress) return;
			//console.log('Check ' + IP);
			GetData('http://' + IP + ':' + ServerPort + '/api/connecttest').then(function(responseText) { // Проверка IP адреса
				if (responseText == 'ok') {
					SyncAddress = 'http://' + IP + ':' + ServerPort;
					FoundIPAddress = true;
					Sync();
				}
			}).catch(function() {
			});
		}
		
		// Список наиболее популярных локальных IP адресов
		let IPs = ['192.168.0.', '192.168.0.', '192.168.1.', '192.168.1.', '192.168.2.', '192.168.3.'];
		let LastAddrs = [     0,            100,          0,            100,          0,            0]; // Начальный адрес
		
		for (let i = 0; i < IPs.length; i++)
			for (let j = 0; j <= 15; j++)
				CheckIPStatus(IPs[i] + (LastAddrs[i] + j));
	}
	
	function SyncAdvance(){
		if (AutoSearchIP)
			SyncWithFoundAddress();
		else
			Sync();
	}
		
	if (DevicePlatform != PlatformIOS) { // На Android и Windows всё хорошо
		function CheckTabletMode(){
			if (window.innerWidth >= 550) {
				TabletMode = true;
				document.getElementById('list').style.display = 'block';
				
				if (document.getElementById('editor').style.display == 'none' && (document.getElementById('settings').style.display == 'none' || document.getElementById('settings').style.display == '')) //Когда блока нет, вместо "none" бывает ""
					document.getElementById('editor').style.display = 'block';
				document.getElementsByClassName('sub-panel')[0].style.cssText = 'border-right: 1px solid var(--list-right-border-color);';
			} else {
				TabletMode = false;
				if (document.getElementById('editor').style.display == 'block' || document.getElementById('settings').style.display == 'block')
					document.getElementById('list').style.display = 'none';
				document.getElementsByClassName('sub-panel')[0].style.cssText = '';
			}
		}
		
		// На iOS нет необходимости из-за проблем
		window.onresize = function(){
			CheckTabletMode();
		}
	
	} else {
		function CheckTabletMode() // Специфика iOS, window.innerWidth не работает, заменяется с height при смене ориентации.
		{
			// Если в useragent есть iPad с любым регистром
			if (/iPad/i.test(window.navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1))
			{
				TabletMode = true;
				document.getElementsByTagName('style')[0].innerHTML +=
				'#list{display:block; float:left; width:37%;}' +
				'#list #items{border-right:1px solid var(--list-right-border-color);}' +
				'.sub-panel{border-right: 1px solid var(--list-right-border-color);}' +
				'#editor{display:block; float:right; width:63%;}' +
				'#settings{float:right; width:63%;}' +
				'.hide-btn img{opacity:0;}';
			} else {
				TabletMode = false;
			}
		}
		
		// iOS блокировка скрола
		function iOSBlockOffsetAppScrolling() {
			let preventScroll = function(event, element) {
				let up = (event.touches[0].clientY > element.slideBeginY);
				let down = (event.touches[0].clientY < element.slideBeginY);
				element.slideBeginY = event.touches[0].clientY;

				if ((up && element.allowUp) || (down && element.allowDown))
					event.stopPropagation();
				else
					event.preventDefault();
			};

			let enableScrollLock = function(elementId) {
				let element = document.getElementById(elementId);

				element.addEventListener('touchstart', function(event) {
					element.allowUp = (element.scrollTop > 0);
					element.allowDown = (element.scrollTop < element.scrollHeight - element.clientHeight);
					element.slideBeginY = event.touches[0].clientY;
				});

				element.addEventListener('touchmove', function(event) {
					preventScroll(event, element);
				});
			};

			enableScrollLock('items');
			enableScrollLock('memo');
			// Настройки не блочим, проблемы при скролинге
		}
	}
	
	// Инициализация
	document.addEventListener('DOMContentLoaded', function(){
		
		// Перевод
		document.getElementById('NotesCount').innerHTML = IDS_NOTES + ' (0)';
		document.getElementById('NoteTitle').innerHTML = IDS_NEW_NOTE;
		document.getElementById('Search').placeholder = IDS_SEARCH;
		document.getElementById('SettingsTitle').innerText = IDS_SETTINGS;
		
		if (UseManualAddress) {
			document.getElementById('SyncAddressTitle').innerText = IDS_SYNC_ADDRESS;
			document.getElementById('SyncPortTitle').innerText = IDS_SYNC_PORT;
			document.getElementById('AutoSearchIPTitle').innerText = IDS_AUTOSEARCH_IP;
			document.getElementById('AboutSync').innerText = IDS_ABOUT_SYNC;
		}
		
		document.getElementById('AutoSyncTitle').innerText = IDS_AUTO_SYNC;
		document.getElementById('AboutAutoSync').innerText = IDS_ABOUT_AUTO_SYNC;
		document.getElementById('DarkThemeTitle').innerText = IDS_DARK_THEME;
		document.getElementById('ThemeTimeTitle').innerText = IDS_THEME_TIME_DEPENDENT;
		document.getElementById('DarkThemeStartTitle').innerText = IDS_DARK_THEME_START;
		document.getElementById('DarkThemeEndTitle').innerText = IDS_DARK_THEME_END;
		document.getElementById('AboutThemeTime').innerText = IDS_ABOUT_THEME_TIME;
		document.getElementById('CategoriesTitle').innerText = IDS_CATEGORIES;
		document.getElementById('LastUpdate').innerText = IDS_LAST_UPDATE;
		document.getElementById('ResetBtn').innerText = IDS_FULL_RESET;
		
		document.getElementById('DaysAgo').innerHTML = NoteDateAgo(GetUTCTimeStamp());
		document.getElementById('DateNote').innerHTML = NoteDate(GetUTCTimeStamp());
		
		// Заметки и события
		if (localStorage.getItem('Notes') != '' && localStorage.getItem('Notes') != null)
			NotesAr = JSON.parse(localStorage.getItem('Notes'));
		if (localStorage.getItem('Actions') != '' && localStorage.getItem('Actions') != null)
			ActionsAr = JSON.parse(localStorage.getItem('Actions'));
		
		// Настройки, Dark theme
		if (localStorage.getItem('DarkThemeStartHour') != null) {
			DarkThemeStartHour = parseInt(localStorage.getItem('DarkThemeStartHour'));
			DarkThemeEndHour = parseInt(localStorage.getItem('DarkThemeEndHour'));
			document.getElementById('DarkThemeStartHour').value=DarkThemeStartHour;
			document.getElementById('DarkThemeEndHour').value=DarkThemeEndHour;
		}
		
		document.getElementsByTagName('meta')['color-scheme']?.setAttribute('content', 'light'); // Сброс, по умолчанию почему-то сохраняется прошлый
		if (localStorage.getItem('DarkTheme') != null && localStorage.getItem('DarkTheme') == 'true') {
			document.getElementById('DarkThemeCB').checked = true;
			DarkTheme();
		} else if (localStorage.getItem('ThemeTime') != null && localStorage.getItem('ThemeTime') == 'true') {
			document.getElementById('ThemeTimeCB').checked = true;
			
			let date = new Date();
			if (date.getHours() < DarkThemeEndHour || date.getHours() >= DarkThemeStartHour) 
				DarkTheme();
		}
		
		// Категории
		if (localStorage.getItem('Categories') != null)
			document.getElementById('CategorySettingsInput').value = localStorage.getItem('Categories');
		else
			document.getElementById('CategorySettingsInput').value = IDS_CATEGORIES_LIST;
		Categories = document.getElementById('CategorySettingsInput').value.split('\n');
		//console.log(Categories);

		CheckTabletMode();

		ShowNotes('');
		
		// Настройки, IP
		// Полный адрес синхронизации
		if (localStorage.getItem('SyncAddress') != null)
			SyncAddress = localStorage.getItem('SyncAddress');
		else
			ShowSettings();
			
		if (localStorage.getItem('ServerAddress') != null) {
			ServerAddress = localStorage.getItem('ServerAddress');
			document.getElementById('ServerAddress').value = ServerAddress;
		}
		
		// Порт
		if (localStorage.getItem('ServerPort') != null) {
			ServerPort = localStorage.getItem('ServerPort');
			document.getElementById('ServerPort').value = ServerPort;
		}
		
		// Автопоиск IP адреса
		if (localStorage.getItem('AutoSearchIP') != null && localStorage.getItem('AutoSearchIP') == 'true') {
			document.getElementById('AutoSearchIPCB').checked = true;
			AutoSearchIP = true;
		}
		
		// Первый запуск
		FirstRun = localStorage.getItem('FirstRun') == null;
		
		// Настройки, Device ID
		if (localStorage.getItem('DeviceID') === null) {
			DeviceID = GetDeviceID();
			localStorage.setItem('DeviceID', DeviceID);
		} else
			DeviceID = localStorage.getItem('DeviceID');
		document.getElementById('DeviceID').innerHTML = 'ID: ' + DeviceID;
		
		// Настройки, автоматическая синхронизация при запуске
		if (localStorage.getItem('AutoSync') != null && localStorage.getItem('AutoSync') == 'true') {
			document.getElementById('AutoSyncCB').checked = true;
			
			if (window.navigator.onLine)
				SyncAdvance();
		} else
			HideFirstNotifyError = false; // Android, неработающая navigator.onLine
		
		// Блокируем скролинг вне приложения для iOS
		if (DevicePlatform == PlatformIOS)
			iOSBlockOffsetAppScrolling();
			
		// Скрываем лишние пункты меню для статичного адреса
		if (UseManualAddress == false) {
			document.querySelectorAll('.HideForStatAddr').forEach(function(element) {
				element.style.display = 'none';
			});
			let AutoSearchIPBlock = document.getElementById('AutoSearchIP').parentElement;

			AutoSearchIPBlock.style.border = '1px solid var(--settings-item-border-color)';
			AutoSearchIPBlock.style.borderTopLeftRadius = '15px';
			AutoSearchIPBlock.style.borderTopRightRadius = '15px';
		}
		
		// PWA
		if (IsPWA && 'serviceWorker' in navigator) {
			navigator.serviceWorker.register('pwa.js');
		}
		
	});
</script>
</head>
<body>
<div id="container">
	<div id="list">
		<div id="panel">
			<div id="btn" onclick="SyncAdvance();rotateSyncBtn(this);"><img src="images/sync.png" /></div>
			<div class="title" id="NotesCount">Заметки (0)</div>
			<div id="btn" onclick="NewNote(true);if (SearchShown) SearchShowHide(); if (CategoriesShownList) ShowHideCategoriesList();"><img src="images/new.png" /></div>
		</div>
		<div id="panel-bg"></div>
		
		<div id="items">
			<!--<div id="note">
				<div id="title">Заголовок</div>
				<div id="date">28 сен. 2018</div>
			</div>-->
		</div>
		<div class="sub-panel">
			<div id="btn" onclick="ShowSettings()"><img src="images/settings.png" /></div>
			<div id="btn" onclick="ShowHideCategoriesList()"><img src="images/folders.png" /></div>
			<div id="search-block"><input id="Search" type="text" onkeyup="ShowNotes(this.value.trim().toLowerCase())" placeholder="Поиск..."></div>
			<div id="btn" onclick="SearchShowHide()"><img src="images/search.png" /></div>
		</div>
	</div>
	
	<div id="editor">
		<div id="panel">
			<div id="btn" class="hide-btn" onclick="BackNote()"><img src="images/back.png" /></div>
			<div class="title" id="NoteTitle">Заметка</div>
			<div id="btn" onclick="NoteDone()"><img src="images/done.png" /></div>
		</div>
		<div id="panel-bg"></div>
		<div id="page">
			<div id="meta" onselectstart="return false">
				<div id="DaysAgo">3 дня назад</div>
				<div id="DateNote" onclick="ChangeDateTimeStatus()">25 сент. 2:29</div>
			</div>
			<textarea id="memo" onclick="HideNoteCategories()" value="Текст"></textarea>
		</div>
		<div class="sub-panel">
			<div id="btn" onclick="RemNote()"><img src="images/rm.png" /></div>
			<!--<div id="btn" onclick="QR()"><img src="images/qr.png" /></div>-->
			<div id="btn" onclick="ShowHideNoteCategories()"><img src="images/folders.png" /></div>
		</div>
		<div id="note-categories"></div>
	</div>
	
	<div id="settings">
		<div id="panel">
			<div id="btn" onclick="BackSettings()"><img src="images/back.png" /></div>
			<div class="title" id="SettingsTitle">Настройки</div>
			<div id="btn" onclick="SettingsDone()"><img src="images/done.png" /></div>
		</div>
		<div id="panel-bg"></div>
		<div id="page">
			<div id="items" class="HideForStatAddr">
				<div id="item" >
					<div class="title" id="SyncAddressTitle">IP или домен</div>
					<div id="control"><input type="text" id="ServerAddress" oninput="if (IsDomain(this.value)) document.getElementById('ServerPort').value='80';" value="192.168.0.1" placeholder="192.168.0.1"></div>
				</div>
				<div id="item">
					<div class="title" id="SyncPortTitle">Порт</div>
					<div id="control"><input type="number" id="ServerPort" value="735"></div>
				</div>
				<div id="item">
					<div class="title" id="AutoSearchIPTitle" style="width:70%;">Автопоиск IP адреса</div>
					<div id="control" style="width:30%;margin-top:-3px;">
						<input type="checkbox" id="AutoSearchIPCB" class="checkbox" /><label for="AutoSearchIPCB" class="switch"></label>
					</div>
				</div>
			</div>
			
			<div id="AboutSync" class="titlebox"></div>
			
			<div id="items">
				<div id="item">
					<div class="title" id="AutoSyncTitle" style="width:70%;">Синхронизация при запуске</div>
					<div id="control" style="width:30%;margin-top:-3px;">
						<input type="checkbox" id="AutoSyncCB" class="checkbox" /><label for="AutoSyncCB" class="switch"></label>
					</div>
				</div>
			</div>
			
			<div id="AboutAutoSync" class="titlebox"></div>
			
			<div id="items">
				<div id="item">
					<div class="title" id="DarkThemeTitle" style="width:70%;">Тёмная тема</div>
					<div id="control" style="width:30%;margin-top:-3px;">
						<input type="checkbox" id="DarkThemeCB" class="checkbox" /><label for="DarkThemeCB" class="switch"></label>
					</div>
				</div>
			</div>
			
			<div id="items">
				<div id="item">
					<div class="title" id="ThemeTimeTitle" style="width:70%;">Тема в зависимости от времени</div>
					<div id="control" style="width:30%;margin-top:-3px;">
						<input type="checkbox" id="ThemeTimeCB" class="checkbox" /><label for="ThemeTimeCB" class="switch"></label>
					</div>
				</div>
				
				<div id="item" >
					<div class="title" id="DarkThemeStartTitle">Начало тёмной темы</div>
					<div id="control"><input type="number" id="DarkThemeStartHour" value="18" min="0" max="23"></div>
				</div>
				<div id="item">
					<div class="title" id="DarkThemeEndTitle">Конец тёмной темы</div>
					<div id="control"><input type="number" id="DarkThemeEndHour" value="8" min="0" max="23"></div>
				</div>
			</div>

			<div id="AboutThemeTime" class="titlebox"></div>
			
			<div id="items">
				<div id="item">
					<div class="title" style="width:30%;" id="CategoriesTitle">Категории</div>
					<textarea id="CategorySettingsInput" style="width:70%;height:76px"></textarea>
				</div>
			</div>
			
			<div class="titlebox" style="text-align:center;"><br><span id="DeviceID"></span><br><span id="localstoragesize">-</span><br><br>EasyNotes<br><span id="LastUpdate"></span> 06.04.25<br><a style="border-bottom:1px dashed var(--title-box-color)" href="https://r57zone.github.io" target="_blank">https://r57zone.github.io</a></div>
			<br>
			<div id="items">
				<div id="item">
					<div class="title" id="ResetBtn" style="width:95%;" onclick="FullReset()">Полный сброс</div>
					<div id="control" style="width:5%;">►</div>
				</div>
			</div>
			<br><br>
		</div>
	</div>
	
	<div id="notification" onclick="this.className='';"></div>
	<div id="sync-progress"></div>
</div>
</body>
</html>